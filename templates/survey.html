<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BIM and Geo Information</title>
    <link rel="icon" type="image/x-icon"  />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #b0c70d;
        --primary-light: rgba(177, 199, 13, 0.301);
        --secondary: #6b7280;
        --secondary-light: rgba(0, 0, 0, 0.23);
        --dark: #111827;
        --form-label: #374151;
        --bg-light: #f3f3f3;
        --bg-light-gray: #f1f3f4;
        --bg-body: #d1d5db;
        --n-a-entry: #a7a8ab;
        --error: #ee5253;
        --side-tab: #4b5563;
        --list-bg: #f5f5f5;
        --light-gray: #eeeeee;
        --dark-gray: #d1d5db;
        --light-green: #fcffe7;
        --white: #ffffff;
        --shadow-header: 0px 1px 3px rgba(0, 0, 0, 0.1),
          0px 1px 2px rgba(0, 0, 0, 0.06);
        --shadow-wrapper: 0px 1px 6px 0px rgba(0, 0, 0, 0.12),
          0px 1px 6px 0px rgba(0, 0, 0, 0.12);
        --border-radius: 8px;
        --transition: all 0.3s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-light);
        color: var(--dark);
        line-height: 1.6;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .container {
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-wrapper);
        width: 100%;
        max-width: 900px;
        padding: 30px;
        margin-bottom: 20px;
        position: relative;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--light-gray);
      }

      .logo {
        max-height: 60px;
      }

      h1 {
        font-size: 28px;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 20px;
        text-align: center;
      }

      .section-title {
        font-size: 18px;
        font-weight: 500;
        color: var(--dark);
        margin-bottom: 15px;
      }

      .error-message {
        background-color: rgba(238, 82, 83, 0.1);
        border-left: 4px solid var(--error);
        color: var(--error);
        padding: 12px 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .info-message {
        background-color: rgba(176, 199, 13, 0.1);
        border-left: 4px solid var(--primary);
        color: var(--dark);
        padding: 12px 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .txts {
        color: var(--dark);
        font-weight: 500;
        margin-bottom: 20px;
        text-align: center;
      }

      /* Table Styles */
      .table-container {
        overflow-x: auto;
        margin-bottom: 25px;
        border-radius: var(--border-radius);
        border: 1px solid var(--light-gray);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      th {
        background-color: var(--primary);
        color: var(--white);
        font-weight: 500;
        padding: 12px 15px;
        text-align: left;
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--light-gray);
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:nth-child(even) {
        background-color: var(--bg-light-gray);
      }

      /* ===== Clean and Centered Source Table Styles ===== */
      .source-table {
        margin: 20px auto;
        width: 95%;
        border-collapse: collapse;
        border-radius: var(--border-radius);
        overflow: hidden;
        background-color: #fff;
        text-align: center;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.04);
      }

      /* Header (Source/Target CRS) */
      .source-table thead th[colspan] {
        background-color: var(--primary-light);
        color: var(--dark);
        font-size: 15px;
        font-weight: 600;
        padding: 12px;
        text-align: center;
      }

      /* Column labels (X, Y, Z, X', Y', Z') */
      .source-table thead tr:nth-child(2) th {
        background-color: var(--primary);
        color: var(--white);
        font-weight: 600;
        font-size: 15px;
        text-align: center;
        padding: 12px 8px;
        vertical-align: middle;
      }

      /* Table rows */
      .source-table tbody tr:nth-child(even) {
        background-color: var(--bg-light-gray);
      }

      /* Table cells */
      .source-table tbody td {
        padding: 10px;
        text-align: center;
      }

      /* Inputs */
      .source-table input.coordinate-input {
        width: 85%;
        margin: 0 auto;
        text-align: center;
        display: block;
        border: 1px solid var(--dark-gray);
        border-radius: 4px;
        font-size: 14px;
        transition: var(--transition);
      }

      .source-table input.coordinate-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(176, 199, 13, 0.25);
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--form-label);
      }

      input[type="text"] {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--dark-gray);
        border-radius: var(--border-radius);
        font-family: "Inter", sans-serif;
        font-size: 15px;
        transition: var(--transition);
      }

      input[type="text"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(176, 199, 13, 0.2);
      }

      .btn {
        background-color: var(--primary);
        color: var(--white);
        border: none;
        padding: 12px 24px;
        border-radius: var(--border-radius);
        font-family: "Inter", sans-serif;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn:hover {
        background-color: #9ab00b;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-secondary {
        background-color: var(--secondary);
      }

      .btn-secondary:hover {
        background-color: #5a6268;
      }

      .btn-success {
        background-color: #28a745;
      }

      .btn-success:hover {
        background-color: #218838;
      }

      .box-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }

      .box-container .box {
        flex: 0 0 250px; /* Keeps consistent width */
      }

      .box {
        background-color: var(--white);
        border: 1px solid var(--light-gray);
        border-radius: var(--border-radius);
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 100%;
      }

      .box:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
      }

      .box img {
        max-width: 100%;
        height: auto;
        margin-bottom: 15px;
      }

      .box-title {
        font-weight: 500;
        margin-bottom: 10px;
        color: var(--dark);
      }

      .box-description {
        font-size: 14px;
        color: var(--secondary);
      }

      /* Coordinate Form */
      .coordinate-form {
        margin-top: 20px;
      }

      .coordinate-row {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--light-gray);
      }

      .coordinate-row:last-child {
        border-bottom: none;
      }

      .coordinate-input {
        padding: 10px;
        border: 1px solid var(--dark-gray);
        border-radius: 4px;
        font-size: 14px;
      }

      .coordinate-input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .auto-mode-notice {
        background-color: var(--light-green);
        border: 1px solid var(--primary-light);
        border-radius: var(--border-radius);
        padding: 15px;
        margin-top: 20px;
      }

      .auto-mode-notice strong {
        color: var(--dark);
        display: block;
        margin-bottom: 8px;
      }

      /* Loader */
      .loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        z-index: 10;
      }

      .loader img {
        width: 80px;
        height: 80px;
        animation: spin 1.5s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 24px;
        }

        .box-container {
          grid-template-columns: 1fr;
        }

        .coordinate-row {
          grid-template-columns: repeat(3, 1fr);
          gap: 8px;
        }

        .coordinate-input {
          font-size: 13px;
          padding: 8px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 15px;
        }

        .header {
          flex-direction: column;
          text-align: center;
        }

        .logo {
          margin-bottom: 10px;
        }

        .coordinate-row {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>BIM and Geo Information</h1>
      </div>

      {% if messages %}
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for message, detail in messages %}
            <tr>
              <td>{{ message }}</td>
              <td>{{ detail }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %} {% if error %}
      <div class="error-message">{{ error }}</div>
      {% endif %} {% if not Num %} {% if Refl %}
      <div class="info-message">
        Choose how you want to georeference your IFC file.
      </div>
      <div class="box-container">
        <div class="box" id="box1">
          <img src="../static/images/way1.png" alt="Use existing information" />
          <div class="box-title">Use existing information</div>
          <div class="box-description">
            Utilize data already available in your IFC file
          </div>
        </div>
        <div class="box" id="box2">
          <img
            src="../static/images/way2.png"
            alt="Add surveyed points to existing information"
          />
          <div class="box-title">Add surveyed points</div>
          <div class="box-description">
            Supplement existing information with new surveyed points
          </div>
        </div>
        <div class="box" id="box3">
          <img
            src="../static/images/way3.png"
            alt="Add surveyed points and ignore existing information"
          />
          <div class="box-title">New surveyed points only</div>
          <div class="box-description">
            Use only new surveyed points, ignoring existing information
          </div>
        </div>
      </div>
      {% else %}
      <form method="POST" onsubmit="showLoader()" id="numForm">
        <div class="form-group">
          <label for="Num">Enter the number of extra surveyed points:</label>
          <input type="text" id="Num" name="Num" />
        </div>
        <input type="submit" value="Set" class="btn" />
      </form>
      {% endif %} {% endif %} {% if Num %}
      <form
        method="POST"
        action="{{ url_for('calculate', filename=filename) }}"
        onsubmit="showLoader()"
        id="coordinateForm"
        class="coordinate-form"
      >
        <div class="table-container">
          <table class="source-table">
            <thead>
              <tr>
                <th colspan="3">Source CRS (IFC) [{{ ifcunit }}]</th>
                <th colspan="3">Target CRS (MAP) [{{ mapunit }}]</th>
              </tr>
              <tr>
                <th>X</th>
                <th>Y</th>
                <th>Z</th>
                <th>X'</th>
                <th>Y'</th>
                <th>Z'</th>
              </tr>
            </thead>
            <tbody>
              {% for row in range(Num) %}
              <tr>
                <td>
                  <input
                    type="text"
                    name="x{{ row }}"
                    id="x{{ row }}"
                    class="coordinate-input"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    name="y{{ row }}"
                    id="y{{ row }}"
                    class="coordinate-input"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    name="z{{ row }}"
                    id="z{{ row }}"
                    class="coordinate-input"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    name="x_prime{{ row }}"
                    id="x_prime{{ row }}"
                    class="coordinate-input"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    name="y_prime{{ row }}"
                    id="y_prime{{ row }}"
                    class="coordinate-input"
                  />
                </td>
                <td>
                  <input
                    type="text"
                    name="z_prime{{ row }}"
                    id="z_prime{{ row }}"
                    class="coordinate-input"
                  />
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <input
          type="submit"
          value="Submit Coordinates"
          class="btn"
          id="submitBtn"
        />

        {% if auto_mode %}
        <div class="auto-mode-notice">
          <strong>ðŸŽ¯ Auto-Georeferencing Active</strong>
          Coordinates will be filled automatically and submitted in 3 seconds...
          <button
            type="button"
            onclick="autoFillAndSubmit()"
            class="btn btn-success"
            style="margin-top: 10px"
          >
            ðŸš€ Submit Now
          </button>
        </div>
        {% endif %}
      </form>
      {% else %}
      <form
        method="POST"
        onsubmit="showLoader()"
        id="numForm"
        style="display: none"
      >
        <input type="hidden" id="boxNumber" name="boxNumber" />
        <div class="form-group">
          <label for="Num">Enter the number of extra surveyed points:</label>
          <input type="text" id="Num" name="Num" />
        </div>
        <input type="submit" value="Set" class="btn" />
      </form>
      {% endif %}

      <div class="loader" id="loader">
        <img
          src="{{ url_for('static', filename='images/loading.png') }}"
          alt="Loading..."
        />
      </div>
    </div>

    <script>
      // Auto-fill coordinates if in auto mode
      {% if auto_mode and building_points and map_points %}
      const buildingPoints = {{ building_points | tojson }};
      const mapPoints = {{ map_points | tojson }};

      function autoFillAndSubmit() {
          console.log('Auto-filling coordinates...');

          for (let i = 0; i < buildingPoints.length; i++) {
              const buildingPoint = buildingPoints[i];
              const mapPoint = mapPoints[i];

              // Fill building coordinates
              document.getElementById(`x${i}`).value = buildingPoint.building.x.toFixed(6);
              document.getElementById(`y${i}`).value = buildingPoint.building.y.toFixed(6);
              document.getElementById(`z${i}`).value = buildingPoint.building.z.toFixed(6);

              // Fill target coordinates
              document.getElementById(`x_prime${i}`).value = mapPoint.coordinates.easting.toFixed(6);
              document.getElementById(`y_prime${i}`).value = mapPoint.coordinates.northing.toFixed(6);
              document.getElementById(`z_prime${i}`).value = mapPoint.coordinates.elevation.toFixed(6);

              // Add visual feedback
              ['x', 'y', 'z', 'x_prime', 'y_prime', 'z_prime'].forEach(prefix => {
                  const input = document.getElementById(`${prefix}${i}`);
                  if (input) {
                      input.style.background = '#d4edda';
                      input.style.border = '2px solid #28a745';
                  }
              });
          }

          // Auto-submit after a short delay
          setTimeout(() => {
              showLoader();
              document.getElementById('coordinateForm').submit();
          }, 1000);
      }

      // Auto-fill on page load and submit after 3 seconds
      window.addEventListener('load', function() {
          autoFillAndSubmit();
      });
      {% endif %}

      function showLoader() {
          document.getElementById('loader').style.display = 'block';
      }

      function hideBoxes(exceptId) {
          const boxes = ['box1', 'box2', 'box3'];
          boxes.forEach(boxId => {
              const box = document.getElementById(boxId);
              if (boxId === exceptId) {
                  box.style.display = 'block';
              } else {
                  box.style.display = 'none';
              }
          });
          if (exceptId === 'box3') {
              Refl = false; // Assuming Refl is a variable accessible in your Javascript context
          }
      }

      document.getElementById('box1').addEventListener('click', function() {
          document.getElementById('numForm').style.display = 'none';
          document.getElementById('boxNumber').value = '1';
          document.getElementById('Num').value = '0';
          showLoader();
          document.getElementById('numForm').submit();
      });

      document.getElementById('box2').addEventListener('click', function() {
          hideBoxes('box2');
          document.getElementById('boxNumber').value = '2';
          document.getElementById('numForm').style.display = 'block';
      });

      document.getElementById('box3').addEventListener('click', function() {
          hideBoxes('box3');
          document.getElementById('boxNumber').value = '3';
          document.getElementById('numForm').style.display = 'block';
      });

      // Auto-populate form if data is available from interactive georeferencing
      document.addEventListener('DOMContentLoaded', function() {
          const georefData = sessionStorage.getItem('interactiveGeorefData');
          if (georefData) {
              try {
                  const data = JSON.parse(georefData);
                  autoPopulateForm(data);
                  sessionStorage.removeItem('interactiveGeorefData'); // Clean up
              } catch (e) {
                  console.log('No interactive georeferencing data found');
              }
          }
      });

      function autoPopulateForm(data) {
          const { buildingPoints, mapPoints, epsg, filename } = data;

          // Show notification
          const notification = document.createElement('div');
          notification.innerHTML = `
              <div style="position: fixed; top: 20px; right: 20px; background: #d4edda;
                        border: 1px solid #c3e6cb; border-radius: 4px; padding: 15px;
                        z-index: 1000; max-width: 300px;">
                  <strong>ðŸŽ¯ Interactive Georeferencing</strong><br>
                  Auto-populating ${buildingPoints.length} survey points...<br>
                  <button onclick="this.parentElement.parentElement.remove()"
                          style="margin-top: 10px; background: #28a745; color: white;
                                border: none; padding: 5px 10px; border-radius: 3px;">
                      Continue
                  </button>
              </div>
          `;
          document.body.appendChild(notification);

          // If we're in the box selection phase, click box3 to proceed
          const box3 = document.getElementById('box3');
          if (box3 && box3.style.display !== 'none') {
              setTimeout(() => {
                  box3.click();
                  // Set the number of points
                  setTimeout(() => {
                      document.getElementById('Num').value = buildingPoints.length;
                      document.getElementById('numForm').submit();
                  }, 500);
              }, 1000);
              return;
          }

          // If we're in the form phase, populate the inputs
          setTimeout(() => {
              for (let i = 0; i < buildingPoints.length; i++) {
                  const buildingPoint = buildingPoints[i];
                  const mapPoint = mapPoints[i];

                  // Populate building coordinates
                  const xInput = document.querySelector(`input[name="x${i}"]`);
                  const yInput = document.querySelector(`input[name="y${i}"]`);
                  const zInput = document.querySelector(`input[name="z${i}"]`);

                  if (xInput) xInput.value = buildingPoint.building.x.toFixed(6);
                  if (yInput) yInput.value = buildingPoint.building.y.toFixed(6);
                  if (zInput) zInput.value = buildingPoint.building.z.toFixed(6);

                  // Populate target coordinates
                  const xPrimeInput = document.querySelector(`input[name="x_prime${i}"]`);
                  const yPrimeInput = document.querySelector(`input[name="y_prime${i}"]`);
                  const zPrimeInput = document.querySelector(`input[name="z_prime${i}"]`);

                  if (xPrimeInput) xPrimeInput.value = mapPoint.coordinates.easting.toFixed(6);
                  if (yPrimeInput) yPrimeInput.value = mapPoint.coordinates.northing.toFixed(6);
                  if (zPrimeInput) zPrimeInput.value = mapPoint.coordinates.elevation.toFixed(6);

                  // Add visual feedback
                  [xInput, yInput, zInput, xPrimeInput, yPrimeInput, zPrimeInput].forEach(input => {
                      if (input) {
                          input.style.background = '#d4edda';
                          input.style.border = '2px solid #28a745';
                      }
                  });
              }

              // Add auto-submit option
              const submitButton = document.querySelector('input[type="submit"]');
              if (submitButton) {
                  const autoSubmitButton = document.createElement('button');
                  autoSubmitButton.innerHTML = 'ðŸš€ Auto-Submit Georeferencing';
                  autoSubmitButton.className = 'btn btn-success';
                  autoSubmitButton.style.marginLeft = '10px';
                  autoSubmitButton.onclick = function(e) {
                      e.preventDefault();
                      showLoader();
                      submitButton.click();
                  };
                  submitButton.parentNode.appendChild(autoSubmitButton);

                  // Auto-submit after a delay
                  setTimeout(() => {
                      if (confirm('Auto-submit the georeferencing now? Click OK to proceed or Cancel to review first.')) {
                          autoSubmitButton.click();
                      }
                  }, 2000);
              }
          }, 500);
      }
    </script>
  </body>
</html>
